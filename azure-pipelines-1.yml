# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
schedules:
- cron: '*/10 14-21 * * 1-5'
  displayName: Daily run
  branches:
    include:
    - master
  always: True

trigger: none 

stages:
- stage: RUN
  displayName: Run image
  jobs:  
  - job: Run
    displayName: Run
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: DownloadBuildArtifacts@0
      inputs:
        buildType: 'specific'
        project: '52448eba-e4d0-40b7-949c-c0e84daf42d4'
        pipeline: '2'
        buildVersionToDownload: 'latest'
        downloadType: 'specific'
        itemPattern: '*$(symbol)_model.h5*'
        downloadPath: '$(System.ArtifactsDirectory)'
    - script: |
        cat $(System.ArtifactsDirectory)/$(symbol)_model.h5
        docker login --username nemaher --password $(pwd)
        docker pull docker.io/nemaher/stocks
        mkdir ~/config
        touch ~/config/config.yml
        echo key_id: $(alpaca_key_id) >> ~/config/config.yml
        echo secret_key: $(alpaca_secret_key) >> ~/config/config.yml
        touch $(Build.ArtifactStagingDirectory)/$(symbol)_model.h5
        docker run -v ~/config:/config nemaher/stocks trade-stocks --symbol $(symbol) --save-path '$(Build.ArtifactStagingDirectory)/$(symbol)_model.h5'
        echo '$(Build.ArtifactStagingDirectory)/$(symbol)_model.h5'
        ls $(Build.ArtifactStagingDirectory)
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: '$(symbol)_model.h5'
        publishLocation: 'Container'

